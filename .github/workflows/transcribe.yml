name: Smart Subtitles (Auto or Generate)

on:
  workflow_dispatch:
    inputs:
      url:
        description: "视频链接（B站/YouTube等）"
        required: true
        type: string
      langs:
        description: "优先字幕语言（逗号分隔/可正则）"
        required: false
        default: "zh-Hans,zh-Hant,en.*"
        type: string
      whisper_model:
        description: "Whisper模型：tiny/base/small/medium/large"
        required: false
        default: "small"
        type: string
      whisper_language:
        description: "Whisper识别语言（留空自动检测）"
        required: false
        default: ""
        type: string
      user_agent:
        description: "可选：浏览器UA"
        required: false
        default: ""
        type: string

jobs:
  smart_subs:
    runs-on: ubuntu-latest
    env:
      YTDLP_COOKIES_TXT: ${{ secrets.YTDLP_COOKIES_TXT }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Python with pip cache
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'  # 现在可以找到 requirements.txt 了

      - name: Cache apt packages (ffmpeg)
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: ffmpeg
          version: 1.0

      - name: Install Python dependencies
        shell: bash
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt

      - name: Cache Whisper models
        uses: actions/cache@v4
        with:
          path: ~/.cache/whisper
          key: whisper-models-${{ inputs.whisper_model }}
          restore-keys: |
            whisper-models-

      - name: Write cookies.txt
        if: ${{ env.YTDLP_COOKIES_TXT != '' }}
        shell: bash
        run: |
          printf '%s' "$YTDLP_COOKIES_TXT" | tr -d '\r' > cookies.txt

      - name: Run smart subtitles script
        env:
          URL: ${{ inputs.url }}
          LANGS: ${{ inputs.langs }}
          WHISPER_MODEL: ${{ inputs.whisper_model }}
          WHISPER_LANG: ${{ inputs.whisper_language }}
          UA: ${{ inputs.user_agent }}
        shell: bash
        run: python smart_subs.py

      - name: Upload subtitles
        uses: actions/upload-artifact@v4
        with:
          name: subtitles
          path: subs/
