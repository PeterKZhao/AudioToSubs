name: Smart Subtitles (Commit Organized)

on:
  workflow_dispatch:
    inputs:
      url:
        description: "视频链接（B站/YouTube等）"
        required: true
        type: string
      langs:
        description: "优先字幕语言（逗号分隔/可正则）"
        required: false
        default: "zh-Hans,zh-Hant,en.*"
        type: string
      whisper_model:
        description: "Whisper模型：tiny/base/small/medium/large"
        required: false
        default: "small"
        type: string
      whisper_language:
        description: "Whisper识别语言（留空自动检测）"
        required: false
        default: ""
        type: string
      user_agent:
        description: "可选：浏览器UA"
        required: false
        default: ""
        type: string

permissions:
  contents: write  # 允许 GITHUB_TOKEN 写入仓库 [web:28][web:31]

concurrency:
  group: smart-subtitles
  cancel-in-progress: false

jobs:
  smart_subs:
    runs-on: ubuntu-latest
    env:
      YTDLP_COOKIES_TXT: ${{ secrets.YTDLP_COOKIES_TXT }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true  # 让后面 git push 直接可用 [web:42]
          fetch-depth: 0

      - name: Setup Node.js (for yt-dlp JS challenges)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install ffmpeg
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          ffmpeg -version

      - name: Setup Python with pip cache
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt

      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install -U pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install -U yt-dlp openai-whisper

      - name: Cache Whisper models
        uses: actions/cache@v4
        with:
          path: ~/.cache/whisper
          key: whisper-models-${{ inputs.whisper_model }}
          restore-keys: |
            whisper-models-

      - name: Write cookies.txt (optional)
        if: ${{ env.YTDLP_COOKIES_TXT != '' }}
        shell: bash
        run: |
          printf '%s' "$YTDLP_COOKIES_TXT" | tr -d '\r' > cookies.txt

      - name: Prepare folders
        shell: bash
        run: |
          mkdir -p subs work

      # 关键：一次 yt-dlp -J 同时做两件事：
      # 1) 计算“每视频目录” out_dir
      # 2) 检测该视频是否有匹配语言字幕（subtitles/automatic_captions）
      - name: Resolve out_dir + Detect subtitle availability
        id: detect
        env:
          URL: ${{ inputs.url }}
          LANGS: ${{ inputs.langs }}
          UA: ${{ inputs.user_agent }}
        shell: bash
        run: |
          python - <<'PY'
          import json, os, re, subprocess
          from pathlib import Path

          url = os.environ["URL"].strip()
          langs = os.environ.get("LANGS","").strip()
          ua = os.environ.get("UA","").strip()
          patterns = [re.compile(x.strip()) for x in langs.split(",") if x.strip()]

          cmd = [
            "yt-dlp",
            "--js-runtimes", "node",
            "--remote-components", "ejs:github",
            "--skip-download",
            "--write-auto-subs",
            "-J",
            url,
          ]
          if os.path.exists("cookies.txt"):
            cmd += ["--cookies", "cookies.txt"]
          if ua:
            cmd += ["--user-agent", ua]

          info_text = subprocess.check_output(cmd, text=True)
          info = json.loads(info_text)

          extractor = info.get("extractor_key") or info.get("extractor") or "unknown"
          channel = info.get("channel_id") or info.get("uploader_id") or info.get("uploader") or "unknown"
          upload_date = info.get("upload_date") or info.get("release_date") or "unknown-date"
          vid = info.get("id") or "unknown-id"

          out_dir = Path("subs") / extractor / channel / f"{upload_date}_{vid}"
          out_dir.mkdir(parents=True, exist_ok=True)

          # 保存溯源信息
          (out_dir / "source_url.txt").write_text(url + "\n", encoding="utf-8")
          (out_dir / "info.json").write_text(info_text + ("\n" if not info_text.endswith("\n") else ""), encoding="utf-8")

          subs = info.get("subtitles") or {}
          auto = info.get("automatic_captions") or {}
          keys = sorted(set(list(subs.keys()) + list(auto.keys())))

          def ok(k: str) -> bool:
            for r in patterns:
              if r.fullmatch(k) or r.search(k):
                return True
            return False

          matched = [k for k in keys if ok(k)]
          mode = "download" if matched else "whisper"

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
            f.write(f"mode={mode}\n")
            f.write("matched_langs=" + ",".join(matched) + "\n")
            f.write(f"out_dir={out_dir.as_posix()}\n")
            f.write(f"video_id={vid}\n")

          print("mode =", mode)
          print("out_dir =", out_dir)
          print("matched_langs =", ",".join(matched) if matched else "(none)")
          PY

      - name: Download existing subtitles into per-video folder
        if: steps.detect.outputs.mode == 'download'
        env:
          URL: ${{ inputs.url }}
          LANGS: ${{ inputs.langs }}
          UA: ${{ inputs.user_agent }}
          OUT_DIR: ${{ steps.detect.outputs.out_dir }}
        shell: bash
        run: |
          set -euo pipefail
          UA_ARGS=()
          if [[ -n "${UA}" ]]; then UA_ARGS=(--user-agent "${UA}"); fi
          COOKIE_ARGS=()
          if [[ -f cookies.txt ]]; then COOKIE_ARGS=(--cookies cookies.txt); fi

          yt-dlp \
            --js-runtimes node --remote-components ejs:github \
            --skip-download \
            --write-subs --write-auto-subs \
            --sub-langs "${LANGS}" \
            --sub-format "vtt/best" \
            --convert-subs srt \
            -o "${OUT_DIR}/%(title).200s_%(id)s.%(ext)s" \
            "${URL}" \
            "${COOKIE_ARGS[@]}" \
            "${UA_ARGS[@]}"

      - name: Decide if Whisper is needed (fallback)
        id: postcheck
        env:
          OUT_DIR: ${{ steps.detect.outputs.out_dir }}
        shell: bash
        run: |
          shopt -s nullglob
          files=("${OUT_DIR}"/*.srt "${OUT_DIR}"/*.vtt "${OUT_DIR}"/*.txt "${OUT_DIR}"/*.lrc)
          if [[ "${{ steps.detect.outputs.mode }}" == "whisper" ]]; then
            echo "need_whisper=true" >> "$GITHUB_OUTPUT"
          elif (( ${#files[@]} == 0 )); then
            echo "need_whisper=true" >> "$GITHUB_OUTPUT"
          else
            echo "need_whisper=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Download audio for Whisper
        if: steps.postcheck.outputs.need_whisper == 'true'
        env:
          URL: ${{ inputs.url }}
          UA: ${{ inputs.user_agent }}
        shell: bash
        run: |
          set -euo pipefail
          UA_ARGS=()
          if [[ -n "${UA}" ]]; then UA_ARGS=(--user-agent "${UA}"); fi
          COOKIE_ARGS=()
          if [[ -f cookies.txt ]]; then COOKIE_ARGS=(--cookies cookies.txt); fi

          yt-dlp \
            --js-runtimes node --remote-components ejs:github \
            -f "bestaudio/best" \
            -o "work/%(id)s.%(ext)s" \
            "${URL}" \
            "${COOKIE_ARGS[@]}" \
            "${UA_ARGS[@]}"

      - name: Whisper generate subtitles (SRT+TXT+VTT) into per-video folder
        if: steps.postcheck.outputs.need_whisper == 'true'
        env:
          MODEL: ${{ inputs.whisper_model }}
          WHISPER_LANG: ${{ inputs.whisper_language }}
          OUT_DIR: ${{ steps.detect.outputs.out_dir }}
        shell: bash
        run: |
          set -euo pipefail
          AUDIO_FILE="$(ls -1 work/* | head -n 1)"

          LANG_ARGS=()
          if [[ -n "${WHISPER_LANG}" ]]; then LANG_ARGS=(--language "${WHISPER_LANG}"); fi

          whisper "${AUDIO_FILE}" \
            --model "${MODEL}" \
            --output_dir "${OUT_DIR}" \
            --output_format "all" \
            "${LANG_ARGS[@]}"

      - name: Convert SRT -> LRC (simple)
        if: steps.postcheck.outputs.need_whisper == 'true'
        env:
          OUT_DIR: ${{ steps.detect.outputs.out_dir }}
        shell: bash
        run: |
          python - <<'PY'
          import glob, os, re
          out_dir = os.environ["OUT_DIR"]

          def srt_time_to_lrc(t):
            hh, mm, rest = t.split(":")
            ss, ms = rest.split(",")
            total_mm = int(hh)*60 + int(mm)
            xx = int(ms)//10
            return f"{total_mm:02d}:{int(ss):02d}.{xx:02d}"

          for srt in glob.glob(os.path.join(out_dir, "*.srt")):
            with open(srt, "r", encoding="utf-8", errors="ignore") as f:
              lines = [x.rstrip("\n") for x in f]

            out = []
            i = 0
            while i < len(lines):
              if re.fullmatch(r"\d+", (lines[i].strip() or "")):
                i += 1
                if i < len(lines) and "-->" in lines[i]:
                  time_line = lines[i]
                  i += 1
                  text = []
                  while i < len(lines) and lines[i].strip() != "":
                    text.append(lines[i].strip())
                    i += 1
                  start = time_line.split("-->")[0].strip()
                  if text:
                    out.append(f"[{srt_time_to_lrc(start)}] " + " ".join(text))
              i += 1

            lrc = os.path.splitext(srt)[0] + ".lrc"
            with open(lrc, "w", encoding="utf-8") as f:
              f.write("\n".join(out).strip() + ("\n" if out else ""))
          PY

      - name: Commit & push subtitles
        env:
          URL: ${{ inputs.url }}
          OUT_DIR: ${{ steps.detect.outputs.out_dir }}
          VIDEO_ID: ${{ steps.detect.outputs.video_id }}
        shell: bash
        run: |
          set -euo pipefail

          # 只提交 subs/，并且只有有变化才提交
          if [[ -z "$(git status --porcelain subs)" ]]; then
            echo "No changes under subs/. Skip commit."
            exit 0
          fi

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add subs
          git commit -m "Add subtitles: ${VIDEO_ID} (${URL})" || exit 0
          git push
